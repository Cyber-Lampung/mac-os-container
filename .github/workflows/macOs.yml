name: Start ngrok TCP for macOS Remote Desktop

on:
  workflow_dispatch:

jobs:
  ngrok-vnc:
    runs-on: [self-hosted, macos]   # wajib: self-hosted macOS runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure ngrok installed (print version)
        run: |
          if ! command -v ngrok >/dev/null 2>&1; then
            echo "ngrok not found â€” please install ngrok on the self-hosted runner."
            exit 1
          fi
          ngrok version

      - name: Start ngrok TCP tunnel (VNC 5900)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # pastikan authtoken terpasang (hanya perlu sekali)
          if ! ngrok config show | grep -q authtoken; then
            ngrok config add-authtoken "$NGROK_AUTH_TOKEN"
          fi

          # Jalankan ngrok tcp untuk port 5900 (VNC). Jalankan di background.
          ngrok tcp 5900 --log=stdout > ngrok-vnc.log 2>&1 &

          # tunggu sebentar lalu ambil info tunnel dari API lokal
          sleep 3
          echo "Ngrok tunnels:"
          curl -s http://127.0.0.1:4040/api/tunnels || true
          echo "----- ngrok log -----"
          tail -n +1 ngrok-vnc.log | sed -n '1,200p'
