name: Start ngrok TCP for macOS Remote Desktop (with logs)

on:
  workflow_dispatch:

jobs:
  ngrok-vnc-with-logs:
    runs-on: [self-hosted, macos]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare timestamp
        id: ts
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Ensure ngrok installed
        run: |
          if ! command -v ngrok >/dev/null 2>&1; then
            echo "ngrok not found. Please install ngrok on the self-hosted runner."
            exit 1
          fi
          ngrok version

      - name: Configure ngrok auth token
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # only add-authtoken if not already configured
          if ! ngrok config show 2>/dev/null | grep -q authtoken; then
            ngrok config add-authtoken "$NGROK_AUTH_TOKEN"
          fi

      - name: Start ngrok TCP (VNC:5900) and record logs
        id: start_ngrok
        run: |
          TIMESTAMP=${{ steps.ts.outputs.timestamp }}
          LOGFILE="ngrok-vnc-${TIMESTAMP}.log"
          echo "Starting ngrok tcp 5900, logfile: $LOGFILE"
          # start ngrok in background; redirect stdout/stderr to logfile
          nohup ngrok tcp 5900 > "$LOGFILE" 2>&1 &
          NGROK_PID=$!
          echo "ngrok PID: $NGROK_PID" > ngrok-pid.txt
          echo "$NGROK_PID" >> ngrok-pid.txt
          # wait a bit for ngrok to register tunnels
          sleep 6
          # fetch tunnels info
          for i in 1 2 3; do
            if curl -s http://127.0.0.1:4040/api/tunnels | grep -q public_url; then
              break
            fi
            sleep 2
          done
          curl -s http://127.0.0.1:4040/api/tunnels > "ngrok-api-${TIMESTAMP}.json" || true
          # parse public URL (tcp)
          PUB=$(python3 - <<PY
import json,sys
try:
  j=json.load(open("ngrok-api-%s.json"%"${TIMESTAMP}"))
  t=j.get("tunnels",[])
  for x in t:
    if x.get("public_url","").startswith("tcp://"):
      print(x.get("public_url"))
      sys.exit(0)
except Exception:
  pass
print("")
PY
)
          echo "public_url=$PUB" >> $GITHUB_OUTPUT
          # write human friendly connection info
          {
            echo "timestamp: ${TIMESTAMP}"
            echo "ngrok_pid: $NGROK_PID"
            echo "public_url: $PUB"
            echo ""
            echo "To connect (VNC client):"
            if [ -n "$PUB" ]; then
              # pub looks like tcp://0.tcp.ngrok.io:xxxxx
              HOSTPORT=${PUB#tcp://}
              echo "vnc://$HOSTPORT"
              echo "Or use VNC client to connect to $HOSTPORT"
            else
              echo "(no public url found in ngrok API)"
            fi
            echo ""
            echo "Local checks:"
            ps aux | grep ngrok | grep -v grep || true
            netstat -an | grep LISTEN | grep 5900 || true
          } > "connection-info-${TIMESTAMP}.txt"

      - name: Collect system & app logs
        run: |
          TIMESTAMP=${{ steps.ts.outputs.timestamp }}
          # basic diagnostics
          echo "=== uname ===" > "sys-info-${TIMESTAMP}.txt"
          uname -a >> "sys-info-${TIMESTAMP}.txt" 2>&1
          echo >> "sys-info-${TIMESTAMP}.txt"
          echo "=== whoami ===" >> "sys-info-${TIMESTAMP}.txt"
          whoami >> "sys-info-${TIMESTAMP}.txt" 2>&1
          echo >> "sys-info-${TIMESTAMP}.txt"
          echo "=== running processes (pgrep ngrok) ===" >> "sys-info-${TIMESTAMP}.txt"
          pgrep -fl ngrok >> "sys-info-${TIMESTAMP}.txt" 2>&1 || true
          echo >> "sys-info-${TIMESTAMP}.txt"
          echo "=== recent system log (last 5m) ===" >> "sys-info-${TIMESTAMP}.txt"
          # macOS unified log - last 5 minutes; adjust if needed
          LOGTIME="-5m"
          if command -v log >/dev/null 2>&1; then
            log show --style syslog --last 5m >> "sys-info-${TIMESTAMP}.txt" 2>&1 || true
          else
            echo "log command not available" >> "sys-info-${TIMESTAMP}.txt"
          fi

      - name: Save VNC info & sample screenshot (optional)
        run: |
          TIMESTAMP=${{ steps.ts.outputs.timestamp }}
          # create a short vnc-info file with hints for connection
          cat > "vnc-hints-${TIMESTAMP}.txt" <<EOT
Hints to connect:
- Use the public tcp host:port from connection-info file (vnc://host:port)
- macOS Screen Sharing expects user account credentials (use the allowed user on the mac)
- If VNC password is set separately, provide that password in your VNC client
- Ngrok free generates ephemeral host:port each run
EOT
          # attempt a simple VNC status check (ncat/netcat may not exist)
          if command -v nc >/dev/null 2>&1; then
            PUB=$(python3 - <<PY
import json,sys
try:
  j=json.load(open("ngrok-api-%s.json"%"${TIMESTAMP}"))
  t=j.get("tunnels",[])
  for x in t:
    if x.get("public_url","").startswith("tcp://"):
      print(x.get("public_url")[6:])  # remove tcp://
      sys.exit(0)
except Exception:
  pass
print("")
PY
)
            if [ -n "$PUB" ]; then
              echo "Attempting TCP connect to $PUB (timeout 5s)" >> "vnc-hints-${TIMESTAMP}.txt"
              (echo > /dev/tcp/${PUB%:*}/${PUB#*:}) >/dev/null 2>&1 && echo "tcp open" >> "vnc-hints-${TIMESTAMP}.txt" || echo "tcp CLOSED or blocked" >> "vnc-hints-${TIMESTAMP}.txt"
            fi
          fi

      - name: Show connection info in logs
        run: |
          TIMESTAMP=${{ steps.ts.outputs.timestamp }}
          echo "----- CONNECTION INFO -----"
          cat "connection-info-${TIMESTAMP}.txt" || true
          echo "----- NGROK LOG PREVIEW -----"
          tail -n 200 "ngrok-vnc-${TIMESTAMP}.log" || true

      - name: Keep tunnel alive for a bit (adjust as needed)
        run: |
          # Menjaga ngrok tetap jalan selama 20 menit agar kamu sempat connect.
          # Jika kamu ingin lebih lama, ubah sleep value. Job akan menunggu.
          echo "Ngrok aktif â€” keeping job alive for 20 minutes to allow remote connection..."
          sleep 1200

      - name: Gather artifacts (logs, info)
        run: |
          TIMESTAMP=${{ steps.ts.outputs.timestamp }}
          mkdir -p artifacts-${TIMESTAMP}
          mv ngrok-vnc-${TIMESTAMP}.log ngrok-api-${TIMESTAMP}.json connection-info-${TIMESTAMP}.txt sys-info-${TIMESTAMP}.txt vnc-hints-${TIMESTAMP}.txt ngrok-pid.txt artifacts-${TIMESTAMP}/ || true
          ls -lah artifacts-${TIMESTAMP} || true

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: ngrok-vnc-logs-${{ steps.ts.outputs.timestamp }}
          path: |
            artifacts-${{ steps.ts.outputs.timestamp }}/

      - name: Stop ngrok (cleanup)
        if: always()
        run: |
          # try to kill ngrok process we started
          if [ -f ngrok-pid.txt ]; then
            NGROK_PID=$(cat ngrok-pid.txt | head -n1)
            echo "Killing ngrok PID: $NGROK_PID"
            kill "$NGROK_PID" 2>/dev/null || true
          fi
          # also kill any leftover ngrok
          pkill ngrok || true
